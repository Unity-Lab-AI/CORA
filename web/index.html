<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C.O.R.A - Cognitive Operations & Reasoning Assistant</title>
    <style>
        :root {
            --bg-main: #0a0a0a;
            --bg-panel: #12121a;
            --bg-darker: #08080c;
            --border-color: #302050;
            --text-main: #e0e0e0;
            --text-dim: #888;
            --accent-magenta: #ff00ff;
            --accent-cyan: #00ffff;
            --ok-color: #00ff88;
            --warn-color: #ffaa00;
            --fail-color: #ff4444;
            --pending-color: #666;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Consolas', 'Monaco', monospace;
            background: var(--bg-main);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
        }

        /* Two Column Layout */
        .container {
            display: grid;
            grid-template-columns: 400px 1fr;
            height: 100vh;
            gap: 0;
        }

        /* Left Panel */
        .left-panel {
            background: var(--bg-panel);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #1a0020 0%, #0d0015 100%);
            border-bottom: 2px solid var(--accent-magenta);
            padding: 15px;
            text-align: center;
        }

        .header h1 {
            font-size: 32px;
            color: var(--accent-magenta);
            text-shadow: 0 0 15px var(--accent-magenta);
            letter-spacing: 8px;
        }

        .header .subtitle {
            font-size: 10px;
            color: var(--text-dim);
            margin-top: 5px;
        }

        .header .version {
            font-size: 11px;
            color: var(--accent-cyan);
            margin-top: 3px;
        }

        /* Waveform - matches boot_display.py exactly */
        .waveform-container {
            background: #0a0a0a;
            border: 1px solid #302050;
            margin: 10px;
            border-radius: 4px;
        }

        #waveformCanvas {
            width: 100%;
            height: 100px;
            display: block;
        }

        /* Speech Text */
        .speech-container {
            background: #1a0020;
            border-bottom: 1px solid var(--border-color);
            padding: 12px;
            min-height: 60px;
        }

        .speech-label {
            font-size: 9px;
            color: var(--accent-cyan);
            margin-bottom: 5px;
        }

        #speechText {
            font-size: 12px;
            color: var(--accent-magenta);
            font-style: italic;
            line-height: 1.4;
        }

        /* Progress Bar */
        .progress-container {
            padding: 10px 15px;
            background: var(--bg-darker);
            border-bottom: 1px solid var(--border-color);
        }

        .progress-bar {
            height: 6px;
            background: #1a1a2a;
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-magenta), var(--accent-cyan));
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 10px;
            color: var(--text-dim);
            margin-top: 5px;
            text-align: center;
        }

        /* Phases */
        .phases-container {
            padding: 10px;
            background: var(--bg-panel);
            border-bottom: 1px solid var(--border-color);
            max-height: 260px;
            overflow-y: auto;
        }

        .phases-header {
            font-size: 10px;
            color: var(--accent-cyan);
            text-align: center;
            margin-bottom: 8px;
        }

        .phases-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 4px;
        }

        .phase-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 10px;
            padding: 3px 5px;
            background: rgba(0,0,0,0.2);
            border-radius: 3px;
        }

        .phase-indicator {
            font-size: 10px;
            width: 14px;
            text-align: center;
        }

        .phase-indicator.pending { color: var(--pending-color); }
        .phase-indicator.running { color: var(--accent-magenta); animation: pulse 1s infinite; }
        .phase-indicator.ok { color: var(--ok-color); }
        .phase-indicator.warn { color: var(--warn-color); }
        .phase-indicator.fail { color: var(--fail-color); }

        @keyframes pulse {
            0%, 100% { opacity: 1; text-shadow: 0 0 5px var(--accent-magenta); }
            50% { opacity: 0.5; }
        }

        /* Stats */
        .stats-section {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .stats-panel {
            background: var(--bg-darker);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 10px;
        }

        .stats-header {
            font-size: 10px;
            color: var(--accent-cyan);
            text-align: center;
            margin-bottom: 8px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
        }

        .stat-label { color: var(--text-dim); }
        .stat-value { color: var(--ok-color); font-weight: bold; }
        .stat-value.warn { color: var(--warn-color); }
        .stat-value.na { color: var(--text-dim); font-weight: normal; }

        .web-notice {
            background: #1a1020;
            border: 1px solid #402050;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
            font-size: 10px;
            text-align: center;
        }

        .web-notice-title {
            color: var(--warn-color);
            font-weight: bold;
            margin-bottom: 5px;
        }

        .web-notice a {
            color: var(--accent-cyan);
            text-decoration: none;
        }

        /* Right Panel - Log */
        .right-panel {
            background: var(--bg-main);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .log-header {
            background: var(--bg-panel);
            border-bottom: 1px solid var(--border-color);
            padding: 10px 15px;
            font-size: 12px;
            color: var(--accent-cyan);
        }

        .log-container {
            flex: 1;
            overflow-y: auto;
            padding: 10px 15px;
            font-size: 11px;
            line-height: 1.6;
        }

        .log-line { margin-bottom: 2px; }
        .log-phase { color: var(--accent-magenta); font-weight: bold; margin-top: 10px; }
        .log-ok { color: var(--ok-color); }
        .log-warn { color: var(--warn-color); }
        .log-fail { color: var(--fail-color); }
        .log-info { color: var(--text-dim); }
        .log-system { color: var(--accent-cyan); }

        /* Chat */
        .chat-section {
            display: none;
            border-top: 1px solid var(--border-color);
            padding: 15px;
            background: var(--bg-panel);
        }

        .chat-section.visible { display: block; }

        .chat-input-container {
            display: flex;
            gap: 10px;
        }

        #chatInput {
            flex: 1;
            background: var(--bg-darker);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 10px;
            color: var(--text-main);
            font-family: inherit;
            font-size: 13px;
        }

        #chatInput:focus {
            outline: none;
            border-color: var(--accent-magenta);
        }

        #sendBtn {
            background: linear-gradient(135deg, var(--accent-magenta), #aa00aa);
            border: none;
            border-radius: 4px;
            padding: 10px 20px;
            color: white;
            font-weight: bold;
            cursor: pointer;
        }

        /* Modals */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.visible { display: flex; }

        .modal {
            background: var(--bg-panel);
            border: 2px solid var(--accent-magenta);
            border-radius: 8px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
        }

        .modal h2 {
            color: var(--accent-magenta);
            margin-bottom: 20px;
            text-align: center;
        }

        .modal-field {
            margin-bottom: 20px;
        }

        .modal-field label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-main);
        }

        .modal-field input {
            width: 100%;
            padding: 10px;
            background: var(--bg-darker);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-main);
            font-family: inherit;
        }

        .modal-field a {
            color: var(--accent-cyan);
            font-size: 12px;
        }

        .modal-btn {
            width: 100%;
            padding: 12px;
            background: var(--accent-magenta);
            border: none;
            border-radius: 4px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }

        .gate-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.95);
            z-index: 999;
            align-items: center;
            justify-content: center;
        }

        .gate-overlay.visible { display: flex; }

        .gate-box {
            background: #1a0000;
            border: 2px solid var(--fail-color);
            border-radius: 8px;
            padding: 30px;
            max-width: 500px;
            text-align: center;
        }

        .gate-box h2 {
            color: var(--fail-color);
            margin-bottom: 15px;
        }

        .gate-box pre {
            background: #0a0a0a;
            padding: 15px;
            border-radius: 4px;
            text-align: left;
            margin: 15px 0;
            color: var(--accent-cyan);
        }

        .gate-box button {
            padding: 12px 30px;
            background: var(--accent-cyan);
            border: none;
            border-radius: 4px;
            color: black;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <!-- Ollama Gate -->
    <div class="gate-overlay" id="gateOverlay">
        <div class="gate-box">
            <h2>[ BLOCKED ]</h2>
            <p>Ollama is not running</p>
            <pre>ollama serve</pre>
            <p style="color: var(--text-dim); font-size: 12px;">Run this in your terminal, then click Retry</p>
            <button onclick="retryOllama()">Retry Connection</button>
        </div>
    </div>

    <!-- API Key Modal -->
    <div class="modal-overlay" id="apiModal">
        <div class="modal">
            <h2>API Configuration</h2>
            <div class="modal-field">
                <label>Pollinations API Key (optional)</label>
                <input type="password" id="pollinationsKey" placeholder="pk_...">
                <a href="https://pollinations.ai" target="_blank">Get key at pollinations.ai</a>
            </div>
            <div class="modal-field">
                <label>GitHub Token (optional)</label>
                <input type="password" id="githubToken" placeholder="ghp_...">
                <a href="https://github.com/settings/tokens" target="_blank">Generate at github.com/settings/tokens</a>
            </div>
            <div class="modal-field">
                <label>Weather API Key (optional)</label>
                <input type="password" id="weatherKey" placeholder="Your OpenWeatherMap key">
                <a href="https://openweathermap.org/api" target="_blank">Get free key at openweathermap.org</a>
            </div>
            <button class="modal-btn" onclick="saveApiKeys()">Save & Continue</button>
            <button class="modal-btn" style="background: #333; margin-top: 10px;" onclick="skipApiKeys()">Skip (Limited Features)</button>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <div class="left-panel">
            <div class="header">
                <h1>C.O.R.A</h1>
                <div class="subtitle">Cognitive Operations & Reasoning Assistant</div>
                <div class="version">v2.4.0 - Unity AI Lab</div>
            </div>

            <div class="waveform-container">
                <canvas id="waveformCanvas"></canvas>
            </div>

            <div class="speech-container">
                <div class="speech-label">CORA SPEAKING:</div>
                <div id="speechText">Initializing...</div>
            </div>

            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">Booting...</div>
            </div>

            <div class="phases-container">
                <div class="phases-header">── BOOT PHASES ──</div>
                <div class="phases-grid" id="phasesSection"></div>
            </div>

            <div class="stats-section">
                <div class="stats-panel">
                    <div class="stats-header">── LIVE SYSTEM STATS ──</div>
                    <div class="stats-grid">
                        <div class="stat-item"><span class="stat-label">CPU:</span><span class="stat-value na">0%</span></div>
                        <div class="stat-item"><span class="stat-label">MEM:</span><span class="stat-value na">0%</span></div>
                        <div class="stat-item"><span class="stat-label">DISK:</span><span class="stat-value na">0%</span></div>
                        <div class="stat-item"><span class="stat-label">GPU:</span><span class="stat-value na">N/A</span></div>
                        <div class="stat-item"><span class="stat-label">VRAM:</span><span class="stat-value na">0%</span></div>
                        <div class="stat-item"><span class="stat-label">NET:</span><span class="stat-value" id="statNet">--</span></div>
                    </div>
                </div>

                <div class="stats-panel">
                    <div class="stats-header">── SERVICE STATUS ──</div>
                    <div class="stats-grid">
                        <div class="stat-item"><span class="stat-label">Ollama:</span><span class="stat-value" id="statOllama">--</span></div>
                        <div class="stat-item"><span class="stat-label">Pollinations:</span><span class="stat-value" id="statPollinations">--</span></div>
                        <div class="stat-item"><span class="stat-label">Weather:</span><span class="stat-value" id="statWeather">--</span></div>
                        <div class="stat-item"><span class="stat-label">Boot:</span><span class="stat-value" id="statBootTime">--</span></div>
                    </div>
                </div>

                <div class="web-notice">
                    <div class="web-notice-title">WEB PREVIEW MODE</div>
                    <div>System stats require desktop app.<br>
                    <a href="https://github.com/Unity-Lab-AI/CORA.git" target="_blank">Download from GitHub</a> and run CORA.bat</div>
                </div>
            </div>

            <div class="chat-section" id="chatSection">
                <div class="chat-input-container">
                    <input type="text" id="chatInput" placeholder="Talk to CORA...">
                    <button id="sendBtn" onclick="sendChat()">Send</button>
                </div>
            </div>
        </div>

        <div class="right-panel">
            <div class="log-header">[ BOOT CONSOLE ]</div>
            <div class="log-container" id="logContainer"></div>
        </div>
    </div>

    <script>
        // ============================================================
        // C.O.R.A Web Interface - Full Boot Sequence with TTS
        // Matches desktop boot_sequence.py exactly
        // ============================================================

        const PHASES = [
            { id: 'waveform', name: '0.8 Waveform', status: 'pending' },
            { id: 'about', name: '0.9 About', status: 'pending' },
            { id: 'voice', name: '1.0 Voice', status: 'pending' },
            { id: 'ai_engine', name: '2.0 AI Engine', status: 'pending' },
            { id: 'ai_models', name: '2.1 Models', status: 'pending' },
            { id: 'hardware', name: '3.0 Hardware', status: 'pending' },
            { id: 'camera', name: '3.1 Camera', status: 'pending' },
            { id: 'tools', name: '4.0 Tools', status: 'pending' },
            { id: 'voice_sys', name: '5.0 Voice Sys', status: 'pending' },
            { id: 'location', name: '6.0 Location', status: 'pending' },
            { id: 'weather', name: '6.1 Weather', status: 'pending' },
            { id: 'news', name: '7.0 News', status: 'pending' },
            { id: 'vision', name: '8.0 Vision', status: 'pending' },
            { id: 'complete', name: '9.0 Complete', status: 'pending' }
        ];

        let bootStartTime = null;
        let ttsEnabled = false;
        let speechSynth = null;
        let waveformActive = false;
        let waveformCtx = null;
        let animationId = null;

        let pollinationsKey = localStorage.getItem('cora_pollinations_key') || '';
        let githubToken = localStorage.getItem('cora_github_key') || '';
        let weatherKey = localStorage.getItem('cora_weather_key') || '';

        // ============================================================
        // TTS - Web Speech API
        // ============================================================

        function initTTS() {
            if ('speechSynthesis' in window) {
                speechSynth = window.speechSynthesis;
                ttsEnabled = true;
                return true;
            }
            return false;
        }

        function speak(text, callback) {
            if (!ttsEnabled || !speechSynth) {
                document.getElementById('speechText').textContent = text;
                if (callback) setTimeout(callback, 100);
                return;
            }

            document.getElementById('speechText').textContent = text;
            speechSynth.cancel();

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 1.0;
            utterance.pitch = 1.1;
            utterance.volume = 1.0;

            const voices = speechSynth.getVoices();
            const femaleVoice = voices.find(v =>
                v.name.includes('Zira') || v.name.includes('Samantha') ||
                v.name.toLowerCase().includes('female')
            ) || voices[0];

            if (femaleVoice) utterance.voice = femaleVoice;

            utterance.onstart = () => startWaveform();
            utterance.onend = () => { stopWaveform(); if (callback) callback(); };
            utterance.onerror = () => { stopWaveform(); if (callback) callback(); };

            speechSynth.speak(utterance);
        }

        function speakAndWait(text) {
            return new Promise(resolve => speak(text, resolve));
        }

        // ============================================================
        // Waveform - EXACT colors from boot_display.py
        // #400060 (outer), #8000a0 (mid), #ff40ff (main), #ffc0ff (bright)
        // ============================================================

        function initWaveform() {
            const canvas = document.getElementById('waveformCanvas');
            waveformCtx = canvas.getContext('2d');
            canvas.width = canvas.offsetWidth * 2;
            canvas.height = 200;
            waveformCtx.scale(2, 2);
            drawIdleWaveform();
        }

        function drawIdleWaveform() {
            const canvas = document.getElementById('waveformCanvas');
            const ctx = waveformCtx;
            const w = canvas.offsetWidth;
            const h = 100;

            ctx.fillStyle = '#0a0a0a';
            ctx.fillRect(0, 0, w, h);

            ctx.strokeStyle = '#302050';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(0, h/2);
            ctx.lineTo(w, h/2);
            ctx.stroke();
        }

        function startWaveform() {
            waveformActive = true;
            animateWaveform();
        }

        function stopWaveform() {
            waveformActive = false;
            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
            }
            setTimeout(drawIdleWaveform, 100);
        }

        function animateWaveform() {
            if (!waveformActive) return;

            const canvas = document.getElementById('waveformCanvas');
            const ctx = waveformCtx;
            const w = canvas.offsetWidth;
            const h = 100;
            const time = Date.now() / 1000;

            ctx.fillStyle = '#0a0a0a';
            ctx.fillRect(0, 0, w, h);

            // Exact layers from boot_display.py
            const layers = [
                { color: '#400060', width: 8 },   // Outer glow
                { color: '#8000a0', width: 5 },   // Mid glow
                { color: '#ff40ff', width: 3 },   // Main wave
                { color: '#ffc0ff', width: 1 }    // Bright core
            ];

            layers.forEach(layer => {
                ctx.strokeStyle = layer.color;
                ctx.lineWidth = layer.width;
                ctx.beginPath();

                for (let x = 0; x < w; x++) {
                    const freq1 = Math.sin(x * 0.02 + time * 4) * 0.8;
                    const freq2 = Math.sin(x * 0.05 + time * 6) * 0.4;
                    const freq3 = Math.sin(x * 0.01 + time * 2.5) * 0.3;
                    const amplitude = (freq1 + freq2 + freq3) * 18;
                    const y = h/2 + amplitude;

                    if (x === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
                ctx.stroke();
            });

            animationId = requestAnimationFrame(animateWaveform);
        }

        // ============================================================
        // Logging & Phases
        // ============================================================

        function log(text, type = 'info') {
            const container = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString('en-US', { hour12: false });
            const line = document.createElement('div');
            line.className = `log-line log-${type}`;

            if (type === 'phase') {
                line.style.marginTop = '10px';
                line.textContent = `[${timestamp}] ═══════════════ ${text} ═══════════════`;
            } else {
                const prefix = type === 'ok' ? '✓' : type === 'warn' ? '⚠' : type === 'fail' ? '✗' : '';
                line.textContent = `[${timestamp}] ${prefix ? prefix + ' ' : ''}${text}`;
            }

            container.appendChild(line);
            container.scrollTop = container.scrollHeight;
        }

        function renderPhases() {
            const container = document.getElementById('phasesSection');
            container.innerHTML = '';
            PHASES.forEach(phase => {
                const item = document.createElement('div');
                item.className = 'phase-item';
                let indicator = '○';
                if (phase.status === 'running') indicator = '◐';
                else if (['ok', 'warn', 'fail'].includes(phase.status)) indicator = '●';
                item.innerHTML = `<span class="phase-indicator ${phase.status}">${indicator}</span><span>${phase.name}</span>`;
                container.appendChild(item);
            });
        }

        function setPhase(id, status) {
            const phase = PHASES.find(p => p.id === id);
            if (phase) { phase.status = status; renderPhases(); }
        }

        function updateProgress(percent, text) {
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressText').textContent = text;
        }

        // ============================================================
        // API Checks
        // ============================================================

        async function checkOllama() {
            try {
                const r = await fetch('http://localhost:11434/api/tags', { method: 'GET' });
                return r.ok;
            } catch { return false; }
        }

        async function getOllamaModels() {
            try {
                const r = await fetch('http://localhost:11434/api/tags');
                const d = await r.json();
                return d.models || [];
            } catch { return []; }
        }

        async function checkPollinations() {
            try {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.onload = () => resolve(true);
                    img.onerror = () => resolve(false);
                    setTimeout(() => resolve(false), 5000);
                    img.src = 'https://image.pollinations.ai/prompt/test?width=64&height=64&nologo=true';
                });
            } catch { return false; }
        }

        async function getLocation() {
            try {
                const pos = await new Promise((r, e) => navigator.geolocation.getCurrentPosition(r, e, { timeout: 5000 }));
                const res = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${pos.coords.latitude}&lon=${pos.coords.longitude}&format=json`);
                if (res.ok) {
                    const d = await res.json();
                    return { city: d.address?.city || d.address?.town || '', state: d.address?.state || '', country: d.address?.country || '' };
                }
            } catch {}
            return null;
        }

        async function getWeather(apiKey) {
            if (!apiKey) return null;
            try {
                const pos = await new Promise((r, e) => navigator.geolocation.getCurrentPosition(r, e, { timeout: 5000 }));
                const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${pos.coords.latitude}&lon=${pos.coords.longitude}&appid=${apiKey}&units=imperial`);
                if (res.ok) return await res.json();
            } catch {}
            return null;
        }

        async function getNews() {
            try {
                const res = await fetch('https://api.rss2json.com/v1/api.json?rss_url=https://news.google.com/rss?hl=en-US');
                if (res.ok) {
                    const d = await res.json();
                    return d.items?.slice(0, 5).map(i => i.title) || [];
                }
            } catch {}
            return [];
        }

        // ============================================================
        // Boot Sequence
        // ============================================================

        async function runBootSequence() {
            bootStartTime = Date.now();

            // PHASE 0.8: WAVEFORM
            setPhase('waveform', 'running');
            log('PHASE 0.8: WAVEFORM VISUAL', 'phase');
            updateProgress(5, 'Initializing waveform...');
            initWaveform();
            log('AudioWaveform canvas initialized', 'ok');
            setPhase('waveform', 'ok');
            await sleep(300);

            // PHASE 0.9: ABOUT
            setPhase('about', 'running');
            log('PHASE 0.9: ABOUT CORA', 'phase');
            updateProgress(10, 'Loading identity...');
            log('═══════════════════════════════════════════════', 'system');
            log('C.O.R.A - Cognitive Operations & Reasoning Assistant', 'system');
            log('═══════════════════════════════════════════════', 'system');
            log('Version: 2.4.0', 'info');
            log('Created by: Unity AI Lab', 'info');
            log('Developers: Hackall360, Sponge, GFourteen', 'info');
            setPhase('about', 'ok');
            await sleep(300);

            // PHASE 1.0: VOICE
            setPhase('voice', 'running');
            log('PHASE 1.0: VOICE SYNTHESIS', 'phase');
            updateProgress(15, 'Initializing voice...');
            const voiceOk = initTTS();
            if (voiceOk) {
                log('Web Speech API initialized', 'ok');
                setPhase('voice', 'ok');
                await speakAndWait("Voice synthesis online. Web Speech API loaded and ready.");
                await speakAndWait("Hey, I'm CORA. Cognitive Operations and Reasoning Assistant. Version 2.4.0. Made by Hackall360, Sponge, and GFourteen over at Unity AI Lab. Let's get this boot going.");
            } else {
                log('Web Speech API not available', 'warn');
                setPhase('voice', 'warn');
            }
            updateProgress(20, 'Voice online');

            // PHASE 2.0: AI ENGINE
            setPhase('ai_engine', 'running');
            log('PHASE 2.0: AI ENGINE', 'phase');
            updateProgress(25, 'Checking Ollama...');
            log('Checking Ollama connection...', 'info');
            const ollamaOk = await checkOllama();
            if (ollamaOk) {
                log('AI Engine online - Ollama', 'ok');
                document.getElementById('statOllama').textContent = 'Online';
                document.getElementById('statOllama').className = 'stat-value';
                setPhase('ai_engine', 'ok');
                await speakAndWait("AI engine online. Ollama is running.");
            } else {
                log('AI Engine not responding', 'fail');
                document.getElementById('statOllama').textContent = 'Offline';
                document.getElementById('statOllama').className = 'stat-value fail';
                setPhase('ai_engine', 'fail');
                document.getElementById('gateOverlay').classList.add('visible');
                return;
            }

            // PHASE 2.1: MODELS
            setPhase('ai_models', 'running');
            log('PHASE 2.1: AI MODELS CHECK', 'phase');
            updateProgress(35, 'Checking models...');
            const models = await getOllamaModels();
            if (models.length > 0) {
                log(`Found ${models.length} models installed`, 'ok');
                models.slice(0, 5).forEach(m => log(`- ${m.name}`, 'info'));
                setPhase('ai_models', 'ok');
                await speakAndWait(`${models.length} AI models loaded and ready.`);
            } else {
                log('No models found', 'warn');
                setPhase('ai_models', 'warn');
            }

            // PHASE 3.0: HARDWARE
            setPhase('hardware', 'running');
            log('PHASE 3.0: HARDWARE CHECK', 'phase');
            updateProgress(45, 'Checking hardware...');
            log('CPU Usage: 0% (web mode)', 'system');
            log('Memory: 0% (web mode)', 'system');
            log('Disk: 0% (web mode)', 'system');
            log('GPU: Not accessible from browser', 'system');
            log('Network: ' + (navigator.onLine ? 'Connected' : 'Disconnected'), navigator.onLine ? 'ok' : 'warn');
            document.getElementById('statNet').textContent = navigator.onLine ? 'Online' : 'Offline';
            setPhase('hardware', 'ok');
            await speakAndWait("Hardware check complete. Running in web mode.");

            // PHASE 3.1: CAMERA
            setPhase('camera', 'running');
            log('PHASE 3.1: CAMERA CHECK', 'phase');
            updateProgress(50, 'Checking camera...');
            if (navigator.mediaDevices?.getUserMedia) {
                log('Camera API available', 'ok');
                setPhase('camera', 'ok');
                await speakAndWait("Camera API available.");
            } else {
                log('Camera API not available', 'warn');
                setPhase('camera', 'warn');
            }

            // PHASE 4.0: TOOLS
            setPhase('tools', 'running');
            log('PHASE 4.0: CORE TOOLS', 'phase');
            updateProgress(55, 'Loading tools...');
            ['LocalStorage', 'Fetch API', 'WebSocket', 'Canvas API', 'Web Audio', 'Geolocation', 'Notifications', 'Clipboard'].forEach(t => log(`${t} - Available`, 'ok'));
            setPhase('tools', 'ok');
            await speakAndWait("8 web APIs loaded and ready.");

            // PHASE 5.0: VOICE SYSTEMS
            setPhase('voice_sys', 'running');
            log('PHASE 5.0: VOICE SYSTEMS', 'phase');
            updateProgress(60, 'Voice systems...');
            log('Speech Synthesis (TTS) - ' + (ttsEnabled ? 'OK' : 'WARN'), ttsEnabled ? 'ok' : 'warn');
            log('Speech Recognition - Available', 'ok');
            setPhase('voice_sys', 'ok');
            await speakAndWait("Voice systems online.");

            // PHASE 6.0: LOCATION
            setPhase('location', 'running');
            log('PHASE 6.0: LOCATION SERVICE', 'phase');
            updateProgress(70, 'Getting location...');
            const location = await getLocation();
            if (location?.city) {
                const locStr = [location.city, location.state, location.country].filter(Boolean).join(', ');
                log(`Location: ${locStr}`, 'ok');
                setPhase('location', 'ok');
                await speakAndWait(`Location detected. We're in ${locStr}.`);
            } else {
                log('Location unavailable', 'warn');
                setPhase('location', 'warn');
            }

            // PHASE 6.1: WEATHER
            setPhase('weather', 'running');
            log('PHASE 6.1: WEATHER SERVICE', 'phase');
            updateProgress(75, 'Getting weather...');
            const weather = await getWeather(weatherKey);
            if (weather) {
                const temp = Math.round(weather.main.temp);
                const cond = weather.weather[0]?.description || 'unknown';
                log(`Weather: ${temp}°F, ${cond}`, 'ok');
                document.getElementById('statWeather').textContent = `${temp}°F`;
                setPhase('weather', 'ok');
                await speakAndWait(`Currently ${temp} degrees and ${cond}.`);
            } else {
                log('Weather unavailable', 'warn');
                document.getElementById('statWeather').textContent = 'N/A';
                document.getElementById('statWeather').className = 'stat-value na';
                setPhase('weather', 'warn');
            }

            // PHASE 7.0: NEWS
            setPhase('news', 'running');
            log('PHASE 7.0: NEWS HEADLINES', 'phase');
            updateProgress(82, 'Fetching news...');
            const headlines = await getNews();
            if (headlines.length > 0) {
                log(`Found ${headlines.length} headlines`, 'ok');
                headlines.slice(0, 3).forEach((h, i) => log(`${i+1}. ${h.substring(0, 60)}...`, 'info'));
                setPhase('news', 'ok');
                await speakAndWait(`Got ${headlines.length} headlines. ${headlines[0]?.substring(0, 80) || ''}`);
            } else {
                log('News unavailable', 'warn');
                setPhase('news', 'warn');
            }

            // PHASE 8.0: VISION
            setPhase('vision', 'running');
            log('PHASE 8.0: VISION TEST', 'phase');
            updateProgress(90, 'Testing vision...');
            const pollinationsOk = await checkPollinations();
            if (pollinationsOk) {
                log('Pollinations API - Online', 'ok');
                document.getElementById('statPollinations').textContent = 'Online';
            } else {
                log('Pollinations API - Unavailable', 'warn');
                document.getElementById('statPollinations').textContent = 'N/A';
                document.getElementById('statPollinations').className = 'stat-value na';
            }
            log('Vision systems ready', 'ok');
            setPhase('vision', 'ok');
            await speakAndWait("Vision systems ready.");

            // PHASE 9.0: COMPLETE
            setPhase('complete', 'running');
            log('PHASE 9.0: BOOT COMPLETE', 'phase');
            updateProgress(100, 'Boot complete!');
            const bootTime = ((Date.now() - bootStartTime) / 1000).toFixed(2);
            document.getElementById('statBootTime').textContent = bootTime + 's';
            log(`Boot completed in ${bootTime}s`, 'ok');
            log('', 'info');
            log('═══════════════════════════════════════════════', 'ok');
            log('C.O.R.A IS ONLINE AND READY', 'ok');
            log('═══════════════════════════════════════════════', 'ok');
            setPhase('complete', 'ok');
            await speakAndWait(`Boot complete in ${bootTime} seconds. CORA is online and ready. What do you need?`);
            document.getElementById('chatSection').classList.add('visible');
            document.getElementById('chatInput').focus();
        }

        function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

        // ============================================================
        // Chat
        // ============================================================

        async function sendChat() {
            const input = document.getElementById('chatInput');
            const msg = input.value.trim();
            if (!msg) return;
            input.value = '';
            log(`USER: ${msg}`, 'system');
            try {
                const res = await fetch('http://localhost:11434/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model: 'dolphin-mistral:7b', prompt: msg, stream: false })
                });
                if (res.ok) {
                    const d = await res.json();
                    const reply = d.response || 'No response';
                    log(`CORA: ${reply}`, 'ok');
                    speak(reply);
                }
            } catch { log('Error communicating with Ollama', 'fail'); }
        }

        document.getElementById('chatInput')?.addEventListener('keypress', e => { if (e.key === 'Enter') sendChat(); });

        // ============================================================
        // Modal Handlers
        // ============================================================

        function saveApiKeys() {
            pollinationsKey = document.getElementById('pollinationsKey').value.trim();
            githubToken = document.getElementById('githubToken').value.trim();
            weatherKey = document.getElementById('weatherKey').value.trim();
            if (pollinationsKey) localStorage.setItem('cora_pollinations_key', pollinationsKey);
            if (githubToken) localStorage.setItem('cora_github_key', githubToken);
            if (weatherKey) localStorage.setItem('cora_weather_key', weatherKey);
            document.getElementById('apiModal').classList.remove('visible');
            runBootSequence();
        }

        function skipApiKeys() {
            document.getElementById('apiModal').classList.remove('visible');
            runBootSequence();
        }

        async function retryOllama() {
            if (await checkOllama()) {
                document.getElementById('gateOverlay').classList.remove('visible');
                runBootSequence();
            } else {
                alert('Ollama still not responding. Make sure "ollama serve" is running.');
            }
        }

        // ============================================================
        // Init
        // ============================================================

        async function init() {
            renderPhases();
            document.getElementById('pollinationsKey').value = pollinationsKey;
            document.getElementById('githubToken').value = githubToken;
            document.getElementById('weatherKey').value = weatherKey;

            if (!(await checkOllama())) {
                document.getElementById('gateOverlay').classList.add('visible');
                return;
            }

            if (!pollinationsKey && !weatherKey) {
                document.getElementById('apiModal').classList.add('visible');
            } else {
                runBootSequence();
            }
        }

        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = () => {};
        }

        window.addEventListener('load', () => setTimeout(init, 500));
    </script>
</body>
</html>
