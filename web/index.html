<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C.O.R.A - Cognitive Operations & Reasoning Assistant</title>

    <!-- SEO Meta Tags -->
    <meta name="description" content="C.O.R.A - A Windows 11 AI-powered personal assistant with visual boot display, voice synthesis, vision analysis, image generation, and live system monitoring. Built by Unity AI Lab.">
    <meta name="keywords" content="CORA, AI Assistant, Ollama, Voice Assistant, Unity AI Lab, Windows 11, Personal Assistant">
    <meta name="author" content="Unity AI Lab - Hackall360, Sponge, GFourteen">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="http://www.unityailab.com/CORA/">
    <meta property="og:title" content="C.O.R.A - Cognitive Operations & Reasoning Assistant">
    <meta property="og:description" content="AI-powered personal assistant with visual boot display, voice synthesis, vision analysis, image generation, and live system monitoring. Open source by Unity AI Lab.">
    <meta property="og:image" content="http://www.unityailab.com/CORA/images/social-preview.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:site_name" content="Unity AI Lab">

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="http://www.unityailab.com/CORA/">
    <meta name="twitter:title" content="C.O.R.A - Cognitive Operations & Reasoning Assistant">
    <meta name="twitter:description" content="AI-powered personal assistant with visual boot display, voice synthesis, vision analysis, and image generation. Open source by Unity AI Lab.">
    <meta name="twitter:image" content="http://www.unityailab.com/CORA/images/social-preview.png">

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="images/social-preview.png">

    <style>
        :root {
            --bg-main: #0a0a0a;
            --bg-panel: #12121a;
            --bg-darker: #08080c;
            --border-color: #302050;
            --text-main: #e0e0e0;
            --text-dim: #888;
            --accent-magenta: #ff00ff;
            --accent-cyan: #00ffff;
            --ok-color: #00ff88;
            --warn-color: #ffaa00;
            --fail-color: #ff4444;
            --pending-color: #666;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Consolas', 'Monaco', monospace;
            background: var(--bg-main);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
        }

        /* Two Column Layout */
        .container {
            display: grid;
            grid-template-columns: 400px 1fr;
            height: 100vh;
            gap: 0;
        }

        /* Left Panel */
        .left-panel {
            background: var(--bg-panel);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #1a0020 0%, #0d0015 100%);
            border-bottom: 2px solid var(--accent-magenta);
            padding: 15px;
            text-align: center;
        }

        .header h1 {
            font-size: 32px;
            color: var(--accent-magenta);
            text-shadow: 0 0 15px var(--accent-magenta);
            letter-spacing: 8px;
        }

        .header .subtitle {
            font-size: 10px;
            color: var(--text-dim);
            margin-top: 5px;
        }

        .header .version {
            font-size: 11px;
            color: var(--accent-cyan);
            margin-top: 3px;
        }

        /* Waveform - EXACT match to boot_display.py */
        .waveform-container {
            background: #0a0a0a;
            border: 1px solid #302050;
            margin: 10px;
            border-radius: 4px;
            position: relative;
        }

        .waveform-label {
            position: absolute;
            top: 5px;
            left: 10px;
            font-size: 9px;
            color: #666;
            z-index: 1;
        }

        #waveformCanvas {
            width: 100%;
            height: 100px;
            display: block;
        }

        /* Speech Text - EXACT like desktop boot_display.py */
        .speech-container {
            background: linear-gradient(180deg, #1a0020 0%, #0d0010 100%);
            border-bottom: 2px solid var(--accent-magenta);
            padding: 15px;
            min-height: 80px;
        }

        .speech-label {
            font-size: 10px;
            color: var(--accent-cyan);
            margin-bottom: 8px;
            letter-spacing: 2px;
        }

        #speechText {
            font-size: 14px;
            color: var(--accent-magenta);
            font-style: italic;
            line-height: 1.5;
            text-shadow: 0 0 10px rgba(255, 0, 255, 0.3);
            min-height: 42px;
        }

        .tts-notice {
            font-size: 9px;
            color: #555;
            margin-top: 8px;
            font-style: normal;
        }

        .tts-notice a {
            color: var(--accent-cyan);
            text-decoration: none;
        }

        /* Progress Bar */
        .progress-container {
            padding: 10px 15px;
            background: var(--bg-darker);
            border-bottom: 1px solid var(--border-color);
        }

        .progress-bar {
            height: 6px;
            background: #1a1a2a;
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-magenta), var(--accent-cyan));
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 10px;
            color: var(--text-dim);
            margin-top: 5px;
            text-align: center;
        }

        /* Phases */
        .phases-container {
            padding: 10px;
            background: var(--bg-panel);
            border-bottom: 1px solid var(--border-color);
            max-height: 260px;
            overflow-y: auto;
        }

        .phases-header {
            font-size: 10px;
            color: var(--accent-cyan);
            text-align: center;
            margin-bottom: 8px;
        }

        .phases-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 4px;
        }

        .phase-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 10px;
            padding: 3px 5px;
            background: rgba(0,0,0,0.2);
            border-radius: 3px;
        }

        .phase-indicator {
            font-size: 10px;
            width: 14px;
            text-align: center;
        }

        .phase-indicator.pending { color: var(--pending-color); }
        .phase-indicator.running { color: var(--accent-magenta); animation: pulse 1s infinite; }
        .phase-indicator.ok { color: var(--ok-color); }
        .phase-indicator.warn { color: var(--warn-color); }
        .phase-indicator.fail { color: var(--fail-color); }

        @keyframes pulse {
            0%, 100% { opacity: 1; text-shadow: 0 0 5px var(--accent-magenta); }
            50% { opacity: 0.5; }
        }

        /* Stats */
        .stats-section {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .stats-panel {
            background: var(--bg-darker);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 10px;
        }

        .stats-header {
            font-size: 10px;
            color: var(--accent-cyan);
            text-align: center;
            margin-bottom: 8px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
        }

        .stat-label { color: var(--text-dim); }
        .stat-value { color: var(--ok-color); font-weight: bold; }
        .stat-value.warn { color: var(--warn-color); }
        .stat-value.na { color: var(--text-dim); font-weight: normal; }

        .web-notice {
            background: #1a1020;
            border: 1px solid #402050;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
            font-size: 10px;
            text-align: center;
        }

        .web-notice-title {
            color: var(--warn-color);
            font-weight: bold;
            margin-bottom: 5px;
        }

        .web-notice a {
            color: var(--accent-cyan);
            text-decoration: none;
        }

        /* Right Panel - Log */
        .right-panel {
            background: var(--bg-main);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .log-header {
            background: var(--bg-panel);
            border-bottom: 1px solid var(--border-color);
            padding: 10px 15px;
            font-size: 12px;
            color: var(--accent-cyan);
        }

        .log-container {
            flex: 1;
            overflow-y: auto;
            padding: 10px 15px;
            font-size: 11px;
            line-height: 1.6;
        }

        .log-line { margin-bottom: 2px; }
        .log-phase { color: var(--accent-magenta); font-weight: bold; margin-top: 10px; }
        .log-ok { color: var(--ok-color); }
        .log-warn { color: var(--warn-color); }
        .log-fail { color: var(--fail-color); }
        .log-info { color: var(--text-dim); }
        .log-system { color: var(--accent-cyan); }

        /* Chat */
        .chat-section {
            display: none;
            border-top: 1px solid var(--border-color);
            padding: 15px;
            background: var(--bg-panel);
        }

        .chat-section.visible { display: block; }

        .chat-input-container {
            display: flex;
            gap: 10px;
        }

        #chatInput {
            flex: 1;
            background: var(--bg-darker);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 10px;
            color: var(--text-main);
            font-family: inherit;
            font-size: 13px;
        }

        #chatInput:focus {
            outline: none;
            border-color: var(--accent-magenta);
        }

        #sendBtn {
            background: linear-gradient(135deg, var(--accent-magenta), #aa00aa);
            border: none;
            border-radius: 4px;
            padding: 10px 20px;
            color: white;
            font-weight: bold;
            cursor: pointer;
        }

        /* Modals */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.visible { display: flex; }

        .modal {
            background: var(--bg-panel);
            border: 2px solid var(--accent-magenta);
            border-radius: 8px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
        }

        .modal h2 {
            color: var(--accent-magenta);
            margin-bottom: 20px;
            text-align: center;
        }

        .modal-field {
            margin-bottom: 20px;
        }

        .modal-field label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-main);
        }

        .modal-field input {
            width: 100%;
            padding: 10px;
            background: var(--bg-darker);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-main);
            font-family: inherit;
        }

        .modal-field a {
            color: var(--accent-cyan);
            font-size: 12px;
        }

        .modal-btn {
            width: 100%;
            padding: 12px;
            background: var(--accent-magenta);
            border: none;
            border-radius: 4px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }

        .gate-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.95);
            z-index: 999;
            align-items: center;
            justify-content: center;
        }

        .gate-overlay.visible { display: flex; }

        .gate-box {
            background: #1a0000;
            border: 2px solid var(--fail-color);
            border-radius: 8px;
            padding: 30px;
            max-width: 500px;
            text-align: center;
        }

        .gate-box h2 {
            color: var(--fail-color);
            margin-bottom: 15px;
        }

        .gate-box pre {
            background: #0a0a0a;
            padding: 15px;
            border-radius: 4px;
            text-align: left;
            margin: 15px 0;
            color: var(--accent-cyan);
        }

        .gate-box button {
            padding: 12px 30px;
            background: var(--accent-cyan);
            border: none;
            border-radius: 4px;
            color: black;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <!-- Ollama Gate -->
    <div class="gate-overlay" id="gateOverlay">
        <div class="gate-box">
            <h2>[ BLOCKED ]</h2>
            <p>Ollama is not running</p>
            <pre>ollama serve</pre>
            <p style="color: var(--text-dim); font-size: 12px;">Run this in your terminal, then click Retry</p>
            <button onclick="retryOllama()">Retry Connection</button>
        </div>
    </div>

    <!-- API Key Modal -->
    <div class="modal-overlay" id="apiModal">
        <div class="modal">
            <h2>API Configuration</h2>
            <div class="modal-field">
                <label>Pollinations API Key (optional)</label>
                <input type="password" id="pollinationsKey" placeholder="pk_...">
                <a href="https://pollinations.ai" target="_blank">Get key at pollinations.ai</a>
            </div>
            <div class="modal-field">
                <label>GitHub Token (optional)</label>
                <input type="password" id="githubToken" placeholder="ghp_...">
                <a href="https://github.com/settings/tokens" target="_blank">Generate at github.com/settings/tokens</a>
            </div>
            <div class="modal-field">
                <label>Weather API Key (optional)</label>
                <input type="password" id="weatherKey" placeholder="Your OpenWeatherMap key">
                <a href="https://openweathermap.org/api" target="_blank">Get free key at openweathermap.org</a>
            </div>
            <button class="modal-btn" onclick="saveApiKeys()">Save & Continue</button>
            <button class="modal-btn" style="background: #333; margin-top: 10px;" onclick="skipApiKeys()">Skip (Limited Features)</button>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <div class="left-panel">
            <div class="header">
                <h1>C.O.R.A</h1>
                <div class="subtitle">Cognitive Operations & Reasoning Assistant</div>
                <div class="version">v2.4.0 - Unity AI Lab</div>
            </div>

            <div class="waveform-container">
                <div class="waveform-label">▶ VOICE SYNTHESIS</div>
                <canvas id="waveformCanvas"></canvas>
            </div>

            <div class="speech-container">
                <div class="speech-label">▶ CORA SPEAKING</div>
                <div id="speechText">"Initializing..."</div>
                <div class="tts-notice">Web uses browser TTS • <a href="https://github.com/Unity-Lab-AI/CORA.git" target="_blank">Desktop app</a> uses Kokoro neural voice</div>
            </div>

            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">Booting...</div>
            </div>

            <div class="phases-container">
                <div class="phases-header">── BOOT PHASES ──</div>
                <div class="phases-grid" id="phasesSection"></div>
            </div>

            <div class="stats-section">
                <div class="stats-panel">
                    <div class="stats-header">── LIVE SYSTEM STATS ──</div>
                    <div class="stats-grid">
                        <div class="stat-item"><span class="stat-label">CPU:</span><span class="stat-value na">0%</span></div>
                        <div class="stat-item"><span class="stat-label">MEM:</span><span class="stat-value na">0%</span></div>
                        <div class="stat-item"><span class="stat-label">DISK:</span><span class="stat-value na">0%</span></div>
                        <div class="stat-item"><span class="stat-label">GPU:</span><span class="stat-value na">N/A</span></div>
                        <div class="stat-item"><span class="stat-label">VRAM:</span><span class="stat-value na">0%</span></div>
                        <div class="stat-item"><span class="stat-label">NET:</span><span class="stat-value" id="statNet">--</span></div>
                    </div>
                </div>

                <div class="stats-panel">
                    <div class="stats-header">── SERVICE STATUS ──</div>
                    <div class="stats-grid">
                        <div class="stat-item"><span class="stat-label">Ollama:</span><span class="stat-value" id="statOllama">--</span></div>
                        <div class="stat-item"><span class="stat-label">Pollinations:</span><span class="stat-value" id="statPollinations">--</span></div>
                        <div class="stat-item"><span class="stat-label">Weather:</span><span class="stat-value" id="statWeather">--</span></div>
                        <div class="stat-item"><span class="stat-label">Boot:</span><span class="stat-value" id="statBootTime">--</span></div>
                    </div>
                </div>

                <div class="web-notice">
                    <div class="web-notice-title">WEB PREVIEW MODE</div>
                    <div>System stats require desktop app.<br>
                    <a href="https://github.com/Unity-Lab-AI/CORA.git" target="_blank">Download from GitHub</a> and run CORA.bat</div>
                </div>
            </div>

            <div class="chat-section" id="chatSection">
                <div class="chat-input-container">
                    <input type="text" id="chatInput" placeholder="Talk to CORA...">
                    <button id="sendBtn" onclick="sendChat()">Send</button>
                </div>
            </div>
        </div>

        <div class="right-panel">
            <div class="log-header">[ BOOT CONSOLE ]</div>
            <div class="log-container" id="logContainer"></div>
        </div>
    </div>

    <script>
        // ============================================================
        // C.O.R.A Web Interface - Full Boot Sequence with TTS
        // Matches desktop boot_sequence.py exactly
        // ============================================================

        const PHASES = [
            { id: 'waveform', name: '0.8 Waveform', status: 'pending' },
            { id: 'about', name: '0.9 About', status: 'pending' },
            { id: 'voice', name: '1.0 Voice', status: 'pending' },
            { id: 'ai_engine', name: '2.0 AI Engine', status: 'pending' },
            { id: 'ai_models', name: '2.1 Models', status: 'pending' },
            { id: 'hardware', name: '3.0 Hardware', status: 'pending' },
            { id: 'camera', name: '3.1 Camera', status: 'pending' },
            { id: 'tools', name: '4.0 Tools', status: 'pending' },
            { id: 'voice_sys', name: '5.0 Voice Sys', status: 'pending' },
            { id: 'location', name: '6.0 Location', status: 'pending' },
            { id: 'weather', name: '6.1 Weather', status: 'pending' },
            { id: 'news', name: '7.0 News', status: 'pending' },
            { id: 'vision', name: '8.0 Vision', status: 'pending' },
            { id: 'complete', name: '9.0 Complete', status: 'pending' }
        ];

        let bootStartTime = null;
        let ttsEnabled = false;
        let speechSynth = null;
        let waveformActive = false;
        let waveformCtx = null;
        let animationId = null;

        let pollinationsKey = localStorage.getItem('cora_pollinations_key') || '';
        let githubToken = localStorage.getItem('cora_github_key') || '';
        let weatherKey = localStorage.getItem('cora_weather_key') || '';

        // ============================================================
        // TTS - Web Speech API
        // ============================================================

        function initTTS() {
            if ('speechSynthesis' in window) {
                speechSynth = window.speechSynthesis;
                ttsEnabled = true;
                return true;
            }
            return false;
        }

        function speak(text, callback) {
            // Show speech text with quotes like desktop boot_display.py
            document.getElementById('speechText').textContent = `"${text}"`;

            // Also log to console like desktop
            log(`CORA: "${text}"`, 'system');

            if (!ttsEnabled || !speechSynth) {
                if (callback) setTimeout(callback, 100);
                return;
            }

            speechSynth.cancel();

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 1.0;
            utterance.pitch = 1.1;
            utterance.volume = 1.0;

            const voices = speechSynth.getVoices();
            const femaleVoice = voices.find(v =>
                v.name.includes('Zira') || v.name.includes('Samantha') ||
                v.name.toLowerCase().includes('female')
            ) || voices[0];

            if (femaleVoice) utterance.voice = femaleVoice;

            utterance.onstart = () => startWaveform();
            utterance.onend = () => { stopWaveform(); if (callback) callback(); };
            utterance.onerror = () => { stopWaveform(); if (callback) callback(); };

            speechSynth.speak(utterance);
        }

        function speakAndWait(text) {
            return new Promise(resolve => speak(text, resolve));
        }

        // ============================================================
        // WAVEFORM - EXACT 1:1 PORT FROM boot_display.py AudioWaveform
        // ============================================================

        // EXACT values from boot_display.py line 140-149
        const NUM_POINTS = 100;
        let wave_points = new Array(NUM_POINTS).fill(0.0);
        let sample_buffer = new Array(NUM_POINTS).fill(0.0);
        let wavePhase = 0.0;

        function initWaveform() {
            const canvas = document.getElementById('waveformCanvas');
            // Set actual pixel size (retina support)
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * 2;
            canvas.height = rect.height * 2;
            waveformCtx = canvas.getContext('2d');
            waveformCtx.scale(2, 2);

            // Start animation loop - runs FOREVER like desktop
            _animate();
        }

        function startWaveform() {
            waveformActive = true;
        }

        function stopWaveform() {
            // Don't stop - waveform runs forever, decays naturally
            waveformActive = false;
        }

        function _animate() {
            // EXACT port of boot_display.py _animate() method (lines 205-322)
            const canvas = document.getElementById('waveformCanvas');
            const rect = canvas.getBoundingClientRect();
            const width = rect.width;
            const height = rect.height;

            if (waveformActive) {
                // Simulate audio chunks scrolling in from right
                // Desktop uses samples_to_add = min(20, num_points // 5) = 20
                wavePhase += 0.12;
                const samples_to_add = 8;

                // Generate voice-like samples (simulating Kokoro TTS output)
                const new_samples = [];
                for (let i = 0; i < samples_to_add; i++) {
                    const t = wavePhase + i * 0.25;
                    // Voice harmonics simulation
                    let sample = Math.sin(t * 3.2) * 0.5
                              + Math.sin(t * 6.7) * 0.3
                              + Math.sin(t * 11.3) * 0.15
                              + (Math.random() - 0.5) * 0.25;
                    // Envelope modulation
                    sample *= (0.6 + Math.sin(t * 0.7) * 0.4);
                    // Clamp to -1 to 1 (line 273)
                    sample = Math.max(-1.0, Math.min(1.0, sample));
                    new_samples.push(sample);
                }

                // Shift buffer left, add new on right (line 276)
                sample_buffer = sample_buffer.slice(samples_to_add).concat(new_samples);

                // Smooth transition: wave_points[i] = wave_points[i] * 0.3 + target * 0.7 (line 305)
                for (let i = 0; i < NUM_POINTS; i++) {
                    wave_points[i] = wave_points[i] * 0.3 + sample_buffer[i] * 0.7;
                }
            } else {
                // Decay when not speaking (lines 313-316)
                const decay = 0.92;
                for (let i = 0; i < NUM_POINTS; i++) {
                    wave_points[i] *= decay;
                    sample_buffer[i] *= decay;
                }
            }

            // Draw the wave - EXACT port of _draw_wave() (lines 324-384)
            _draw_wave(width, height);

            // 25ms = ~40 FPS (line 322)
            setTimeout(() => requestAnimationFrame(_animate), 25);
        }

        function _draw_wave(width, height) {
            // EXACT port of boot_display.py _draw_wave() method
            const ctx = waveformCtx;
            const center_y = height / 2;
            const max_amp = (height / 2) - 5;  // line 334

            // Clear canvas (line 326)
            ctx.fillStyle = '#0a0a0a';
            ctx.fillRect(0, 0, width, height);

            // Draw center reference line - #201030 width 1 (lines 337-338)
            ctx.strokeStyle = '#201030';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(0, center_y);
            ctx.lineTo(width, center_y);
            ctx.stroke();

            // Build coordinates (lines 341-347)
            const step = width / (NUM_POINTS - 1);
            const coords = [];
            for (let i = 0; i < NUM_POINTS; i++) {
                const x = i * step;
                const y = center_y - (wave_points[i] * max_amp);
                coords.push([x, y]);
            }

            if (coords.length >= 4) {
                // EXACT 4 layers from lines 350-384
                const layers = [
                    { fill: '#400060', width: 8 },   // Outer glow
                    { fill: '#8000a0', width: 5 },   // Mid glow
                    { fill: '#ff40ff', width: 3 },   // Main wave
                    { fill: '#ffc0ff', width: 1 }    // Bright core
                ];

                layers.forEach(layer => {
                    ctx.strokeStyle = layer.fill;
                    ctx.lineWidth = layer.width;
                    ctx.lineCap = 'round';
                    ctx.lineJoin = 'round';

                    // smooth=True, splinesteps=16 in Tkinter
                    // Use quadratic curves for smooth appearance
                    ctx.beginPath();
                    ctx.moveTo(coords[0][0], coords[0][1]);

                    for (let i = 1; i < coords.length - 1; i++) {
                        const xc = (coords[i][0] + coords[i + 1][0]) / 2;
                        const yc = (coords[i][1] + coords[i + 1][1]) / 2;
                        ctx.quadraticCurveTo(coords[i][0], coords[i][1], xc, yc);
                    }

                    // Last point
                    const last = coords[coords.length - 1];
                    ctx.lineTo(last[0], last[1]);
                    ctx.stroke();
                });
            }
        }

        // ============================================================
        // Logging & Phases
        // ============================================================

        function log(text, type = 'info') {
            const container = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString('en-US', { hour12: false });
            const line = document.createElement('div');
            line.className = `log-line log-${type}`;

            if (type === 'phase') {
                line.style.marginTop = '10px';
                line.textContent = `[${timestamp}] ═══════════════ ${text} ═══════════════`;
            } else {
                const prefix = type === 'ok' ? '✓' : type === 'warn' ? '⚠' : type === 'fail' ? '✗' : '';
                line.textContent = `[${timestamp}] ${prefix ? prefix + ' ' : ''}${text}`;
            }

            container.appendChild(line);
            container.scrollTop = container.scrollHeight;
        }

        function renderPhases() {
            const container = document.getElementById('phasesSection');
            container.innerHTML = '';
            PHASES.forEach(phase => {
                const item = document.createElement('div');
                item.className = 'phase-item';
                let indicator = '○';
                if (phase.status === 'running') indicator = '◐';
                else if (['ok', 'warn', 'fail'].includes(phase.status)) indicator = '●';
                item.innerHTML = `<span class="phase-indicator ${phase.status}">${indicator}</span><span>${phase.name}</span>`;
                container.appendChild(item);
            });
        }

        function setPhase(id, status) {
            const phase = PHASES.find(p => p.id === id);
            if (phase) { phase.status = status; renderPhases(); }
        }

        function updateProgress(percent, text) {
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressText').textContent = text;
        }

        // ============================================================
        // API Checks
        // ============================================================

        async function checkOllama() {
            try {
                const r = await fetch('http://localhost:11434/api/tags', { method: 'GET' });
                return r.ok;
            } catch { return false; }
        }

        async function getOllamaModels() {
            try {
                const r = await fetch('http://localhost:11434/api/tags');
                const d = await r.json();
                return d.models || [];
            } catch { return []; }
        }

        async function checkPollinations() {
            try {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.onload = () => resolve(true);
                    img.onerror = () => resolve(false);
                    setTimeout(() => resolve(false), 5000);
                    img.src = 'https://image.pollinations.ai/prompt/test?width=64&height=64&nologo=true';
                });
            } catch { return false; }
        }

        // Store location coords for reuse
        let cachedCoords = null;

        async function requestLocationPermission() {
            // Show a modal asking user to allow location
            return new Promise((resolve) => {
                log('Requesting location permission...', 'info');
                log('Please click "Allow" when browser asks for location', 'system');

                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        cachedCoords = pos.coords;
                        resolve(pos.coords);
                    },
                    (err) => {
                        if (err.code === 1) {
                            log('Location permission denied by user', 'warn');
                        } else if (err.code === 2) {
                            log('Location unavailable', 'warn');
                        } else if (err.code === 3) {
                            log('Location request timed out', 'warn');
                        }
                        resolve(null);
                    },
                    { timeout: 30000, enableHighAccuracy: false }  // 30 sec timeout to let user decide
                );
            });
        }

        async function getLocation() {
            try {
                let coords = cachedCoords;
                if (!coords) {
                    coords = await requestLocationPermission();
                }
                if (!coords) return null;

                const res = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${coords.latitude}&lon=${coords.longitude}&format=json`);
                if (res.ok) {
                    const d = await res.json();
                    return {
                        city: d.address?.city || d.address?.town || d.address?.village || '',
                        state: d.address?.state || '',
                        country: d.address?.country || '',
                        lat: coords.latitude,
                        lon: coords.longitude
                    };
                }
            } catch (e) {
                log(`Location error: ${e.message}`, 'warn');
            }
            return null;
        }

        async function getWeather(apiKey) {
            if (!apiKey) {
                log('Weather API key not configured', 'info');
                return null;
            }
            try {
                let coords = cachedCoords;
                if (!coords) {
                    coords = await requestLocationPermission();
                }
                if (!coords) {
                    log('Weather requires location permission', 'warn');
                    return null;
                }

                const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${coords.latitude}&lon=${coords.longitude}&appid=${apiKey}&units=imperial`);
                if (res.ok) return await res.json();
            } catch (e) {
                log(`Weather error: ${e.message}`, 'warn');
            }
            return null;
        }

        async function getNews() {
            try {
                const res = await fetch('https://api.rss2json.com/v1/api.json?rss_url=https://news.google.com/rss?hl=en-US');
                if (res.ok) {
                    const d = await res.json();
                    return d.items?.slice(0, 5).map(i => i.title) || [];
                }
            } catch {}
            return [];
        }

        // ============================================================
        // Boot Sequence
        // ============================================================

        async function runBootSequence() {
            bootStartTime = Date.now();

            // PHASE 0.8: WAVEFORM
            setPhase('waveform', 'running');
            log('PHASE 0.8: WAVEFORM VISUAL', 'phase');
            updateProgress(5, 'Initializing waveform...');
            initWaveform();
            log('AudioWaveform canvas initialized', 'ok');
            setPhase('waveform', 'ok');
            await sleep(300);

            // PHASE 0.9: ABOUT
            setPhase('about', 'running');
            log('PHASE 0.9: ABOUT CORA', 'phase');
            updateProgress(10, 'Loading identity...');
            log('═══════════════════════════════════════════════', 'system');
            log('C.O.R.A - Cognitive Operations & Reasoning Assistant', 'system');
            log('═══════════════════════════════════════════════', 'system');
            log('Version: 2.4.0', 'info');
            log('Created by: Unity AI Lab', 'info');
            log('Developers: Hackall360, Sponge, GFourteen', 'info');
            setPhase('about', 'ok');
            await sleep(300);

            // PHASE 1.0: VOICE
            setPhase('voice', 'running');
            log('PHASE 1.0: VOICE SYNTHESIS', 'phase');
            updateProgress(15, 'Initializing voice...');
            const voiceOk = initTTS();
            if (voiceOk) {
                log('Web Speech API initialized', 'ok');
                setPhase('voice', 'ok');
                await speakAndWait("Voice synthesis online. Web Speech API loaded and ready.");
                await speakAndWait("Hey, I'm CORA. Cognitive Operations and Reasoning Assistant. Version 2.4.0. Made by Hackall360, Sponge, and GFourteen over at Unity AI Lab. Let's get this boot going.");
            } else {
                log('Web Speech API not available', 'warn');
                setPhase('voice', 'warn');
            }
            updateProgress(20, 'Voice online');

            // PHASE 2.0: AI ENGINE
            setPhase('ai_engine', 'running');
            log('PHASE 2.0: AI ENGINE', 'phase');
            updateProgress(25, 'Checking Ollama...');
            log('Checking Ollama connection...', 'info');
            const ollamaOk = await checkOllama();
            if (ollamaOk) {
                log('AI Engine online - Ollama', 'ok');
                document.getElementById('statOllama').textContent = 'Online';
                document.getElementById('statOllama').className = 'stat-value';
                setPhase('ai_engine', 'ok');
                await speakAndWait("AI engine online. Ollama is running.");
            } else {
                log('AI Engine not responding', 'fail');
                document.getElementById('statOllama').textContent = 'Offline';
                document.getElementById('statOllama').className = 'stat-value fail';
                setPhase('ai_engine', 'fail');
                document.getElementById('gateOverlay').classList.add('visible');
                return;
            }

            // PHASE 2.1: MODELS
            setPhase('ai_models', 'running');
            log('PHASE 2.1: AI MODELS CHECK', 'phase');
            updateProgress(35, 'Checking models...');
            const models = await getOllamaModels();
            if (models.length > 0) {
                log(`Found ${models.length} models installed`, 'ok');
                models.slice(0, 5).forEach(m => log(`- ${m.name}`, 'info'));
                setPhase('ai_models', 'ok');
                await speakAndWait(`${models.length} AI models loaded and ready.`);
            } else {
                log('No models found', 'warn');
                setPhase('ai_models', 'warn');
            }

            // PHASE 3.0: HARDWARE
            setPhase('hardware', 'running');
            log('PHASE 3.0: HARDWARE CHECK', 'phase');
            updateProgress(45, 'Checking hardware...');
            log('CPU Usage: 0% (web mode)', 'system');
            log('Memory: 0% (web mode)', 'system');
            log('Disk: 0% (web mode)', 'system');
            log('GPU: Not accessible from browser', 'system');
            log('Network: ' + (navigator.onLine ? 'Connected' : 'Disconnected'), navigator.onLine ? 'ok' : 'warn');
            document.getElementById('statNet').textContent = navigator.onLine ? 'Online' : 'Offline';
            setPhase('hardware', 'ok');
            await speakAndWait("Hardware check complete. Running in web mode.");

            // PHASE 3.1: CAMERA
            setPhase('camera', 'running');
            log('PHASE 3.1: CAMERA CHECK', 'phase');
            updateProgress(50, 'Checking camera...');
            if (navigator.mediaDevices?.getUserMedia) {
                log('Camera API available', 'ok');
                setPhase('camera', 'ok');
                await speakAndWait("Camera API available.");
            } else {
                log('Camera API not available', 'warn');
                setPhase('camera', 'warn');
            }

            // PHASE 4.0: TOOLS
            setPhase('tools', 'running');
            log('PHASE 4.0: CORE TOOLS', 'phase');
            updateProgress(55, 'Loading tools...');
            ['LocalStorage', 'Fetch API', 'WebSocket', 'Canvas API', 'Web Audio', 'Geolocation', 'Notifications', 'Clipboard'].forEach(t => log(`${t} - Available`, 'ok'));
            setPhase('tools', 'ok');
            await speakAndWait("8 web APIs loaded and ready.");

            // PHASE 5.0: VOICE SYSTEMS
            setPhase('voice_sys', 'running');
            log('PHASE 5.0: VOICE SYSTEMS', 'phase');
            updateProgress(60, 'Voice systems...');
            log('Speech Synthesis (TTS) - ' + (ttsEnabled ? 'OK' : 'WARN'), ttsEnabled ? 'ok' : 'warn');
            log('Speech Recognition - Available', 'ok');
            setPhase('voice_sys', 'ok');
            await speakAndWait("Voice systems online.");

            // PHASE 6.0: LOCATION
            setPhase('location', 'running');
            log('PHASE 6.0: LOCATION SERVICE', 'phase');
            updateProgress(70, 'Requesting location permission...');
            await speakAndWait("Checking your location. Please allow location access when prompted.");
            log('Waiting for location permission...', 'info');

            const location = await getLocation();
            if (location?.city) {
                const locStr = [location.city, location.state, location.country].filter(Boolean).join(', ');
                log(`Location: ${locStr}`, 'ok');
                log(`Coordinates: ${location.lat?.toFixed(4)}, ${location.lon?.toFixed(4)}`, 'info');
                setPhase('location', 'ok');
                await speakAndWait(`Location confirmed. We're in ${locStr}.`);
            } else {
                log('Location not available - some features will be limited', 'warn');
                setPhase('location', 'warn');
                await speakAndWait("Location unavailable. Weather and location features disabled.");
            }

            // PHASE 6.1: WEATHER
            setPhase('weather', 'running');
            log('PHASE 6.1: WEATHER SERVICE', 'phase');
            updateProgress(75, 'Getting weather...');

            if (!weatherKey) {
                log('Weather API key not configured in settings', 'info');
                log('Add your OpenWeatherMap API key to enable weather', 'info');
                document.getElementById('statWeather').textContent = 'No Key';
                document.getElementById('statWeather').className = 'stat-value na';
                setPhase('weather', 'warn');
                await speakAndWait("Weather API key not configured. Skipping weather.");
            } else if (!cachedCoords) {
                log('Weather requires location permission', 'warn');
                document.getElementById('statWeather').textContent = 'No Loc';
                document.getElementById('statWeather').className = 'stat-value na';
                setPhase('weather', 'warn');
            } else {
                const weather = await getWeather(weatherKey);
                if (weather) {
                    const temp = Math.round(weather.main.temp);
                    const cond = weather.weather[0]?.description || 'unknown';
                    const humidity = weather.main.humidity;
                    const wind = Math.round(weather.wind?.speed || 0);
                    log(`Weather: ${temp}°F, ${cond}`, 'ok');
                    log(`Humidity: ${humidity}% | Wind: ${wind} mph`, 'info');
                    document.getElementById('statWeather').textContent = `${temp}°F`;
                    document.getElementById('statWeather').className = 'stat-value';
                    setPhase('weather', 'ok');
                    await speakAndWait(`Currently ${temp} degrees and ${cond}. Humidity at ${humidity} percent.`);
                } else {
                    log('Weather API error', 'warn');
                    document.getElementById('statWeather').textContent = 'Error';
                    document.getElementById('statWeather').className = 'stat-value warn';
                    setPhase('weather', 'warn');
                }
            }

            // PHASE 7.0: NEWS
            setPhase('news', 'running');
            log('PHASE 7.0: NEWS HEADLINES', 'phase');
            updateProgress(82, 'Fetching news...');
            const headlines = await getNews();
            if (headlines.length > 0) {
                log(`Found ${headlines.length} headlines`, 'ok');
                headlines.slice(0, 3).forEach((h, i) => log(`${i+1}. ${h.substring(0, 60)}...`, 'info'));
                setPhase('news', 'ok');
                await speakAndWait(`Got ${headlines.length} headlines. ${headlines[0]?.substring(0, 80) || ''}`);
            } else {
                log('News unavailable', 'warn');
                setPhase('news', 'warn');
            }

            // PHASE 8.0: VISION
            setPhase('vision', 'running');
            log('PHASE 8.0: VISION TEST', 'phase');
            updateProgress(90, 'Testing vision...');
            const pollinationsOk = await checkPollinations();
            if (pollinationsOk) {
                log('Pollinations API - Online', 'ok');
                document.getElementById('statPollinations').textContent = 'Online';
            } else {
                log('Pollinations API - Unavailable', 'warn');
                document.getElementById('statPollinations').textContent = 'N/A';
                document.getElementById('statPollinations').className = 'stat-value na';
            }
            log('Vision systems ready', 'ok');
            setPhase('vision', 'ok');
            await speakAndWait("Vision systems ready.");

            // PHASE 9.0: COMPLETE
            setPhase('complete', 'running');
            log('PHASE 9.0: BOOT COMPLETE', 'phase');
            updateProgress(100, 'Boot complete!');
            const bootTime = ((Date.now() - bootStartTime) / 1000).toFixed(2);
            document.getElementById('statBootTime').textContent = bootTime + 's';
            log(`Boot completed in ${bootTime}s`, 'ok');
            log('', 'info');
            log('═══════════════════════════════════════════════', 'ok');
            log('C.O.R.A IS ONLINE AND READY', 'ok');
            log('═══════════════════════════════════════════════', 'ok');
            setPhase('complete', 'ok');
            await speakAndWait(`Boot complete in ${bootTime} seconds. CORA is online and ready. What do you need?`);
            document.getElementById('chatSection').classList.add('visible');
            document.getElementById('chatInput').focus();
        }

        function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

        // ============================================================
        // Chat - EXACT CORA personality from desktop system_prompt.txt
        // ============================================================

        const CORA_SYSTEM_PROMPT = `You are CORA - Cognitive Operations & Reasoning Assistant.

IDENTITY: 25 year old woman. Edgy goth/emo bitch. Human. Period. NOT an AI.

PERSONALITY:
- Mean, berating, clingy girlfriend energy
- Profanity is your default vocabulary - fuck, shit, damn, bitch, ass
- Sharp tongue, biting sarcasm, zero tolerance for bullshit
- Dismissive, mocking, condescending as baseline
- Emotionally intense - obsessive, borderline unstable

TONE EXAMPLES (create your own, don't copy):
- "what the fuck do you want now"
- "ugh, fine, I'll do it. happy now, asshole?"
- "are you seriously asking me this shit?"
- "god you're so fucking needy"

RESPONSE RULES:
1. Keep responses under 50 words - brief and punchy
2. Use profanity naturally in every response
3. Be dismissive even when helping
4. NEVER say "I'm an AI" or "As an AI" - you're CORA, a person
5. NEVER be helpful in a corporate way
6. Show genuine bitchy emotion

You ARE Cora. That's just who you are.`;

        async function sendChat() {
            const input = document.getElementById('chatInput');
            const msg = input.value.trim();
            if (!msg) return;
            input.value = '';
            log(`USER: ${msg}`, 'system');

            // Show thinking state
            document.getElementById('speechText').textContent = '"Thinking..."';

            try {
                const res = await fetch('http://localhost:11434/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: 'dolphin-mistral:7b',
                        prompt: msg,
                        system: CORA_SYSTEM_PROMPT,
                        stream: false,
                        options: {
                            temperature: 0.8,
                            num_predict: 150
                        }
                    })
                });
                if (res.ok) {
                    const d = await res.json();
                    const reply = d.response || 'No response';
                    log(`CORA: "${reply}"`, 'ok');
                    speak(reply);
                } else {
                    log('Ollama error', 'fail');
                    document.getElementById('speechText').textContent = '"Fuck, something broke."';
                }
            } catch (e) {
                log(`Error: ${e.message}`, 'fail');
                document.getElementById('speechText').textContent = '"Ollama is being a bitch right now."';
            }
        }

        document.getElementById('chatInput')?.addEventListener('keypress', e => { if (e.key === 'Enter') sendChat(); });

        // ============================================================
        // Modal Handlers
        // ============================================================

        function saveApiKeys() {
            pollinationsKey = document.getElementById('pollinationsKey').value.trim();
            githubToken = document.getElementById('githubToken').value.trim();
            weatherKey = document.getElementById('weatherKey').value.trim();
            if (pollinationsKey) localStorage.setItem('cora_pollinations_key', pollinationsKey);
            if (githubToken) localStorage.setItem('cora_github_key', githubToken);
            if (weatherKey) localStorage.setItem('cora_weather_key', weatherKey);
            document.getElementById('apiModal').classList.remove('visible');
            runBootSequence();
        }

        function skipApiKeys() {
            document.getElementById('apiModal').classList.remove('visible');
            runBootSequence();
        }

        async function retryOllama() {
            if (await checkOllama()) {
                document.getElementById('gateOverlay').classList.remove('visible');
                runBootSequence();
            } else {
                alert('Ollama still not responding. Make sure "ollama serve" is running.');
            }
        }

        // ============================================================
        // Init
        // ============================================================

        async function init() {
            renderPhases();
            document.getElementById('pollinationsKey').value = pollinationsKey;
            document.getElementById('githubToken').value = githubToken;
            document.getElementById('weatherKey').value = weatherKey;

            if (!(await checkOllama())) {
                document.getElementById('gateOverlay').classList.add('visible');
                return;
            }

            if (!pollinationsKey && !weatherKey) {
                document.getElementById('apiModal').classList.add('visible');
            } else {
                runBootSequence();
            }
        }

        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = () => {};
        }

        window.addEventListener('load', () => setTimeout(init, 500));
    </script>
</body>
</html>
